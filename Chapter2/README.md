## The framework


#### Detection of sample mix-ups
In the hihi dataset, we became aware of a sample mix-up after checking the consistency of individual sex (based on sexually dimorphic plumage and other morphological features and on previous genotyping of two sex-linked microsatellite markers) against the heterozygosity values of genotyped Z-linked SNP array markers for the Tiritiri Matangi individuals. A substantial number of sex-mismatches were identified, and so we then compared pedigree-based and genomic-based pairwise relatedness values for individuals in the population (Figure 3 in the manuscript). As the hihi pedigree for the genotyped hihi is verified based on microsatellite data, the sex discrepancy and the discrepancy between pedigree and genomic relatedness confirmed that there had been substantial sample mix-ups in the research project.
Because the same genetic samples had previously been genotyped at microsatellite loci, which had confirmed the relationship between mothers and their offspring, we assessed that the sample mix-up was unlikely to have occurred in the field or during transport. The DNA from the hihi blood samples has been extracted on two separate occasions for the microsatellite data and the SNP array genotyping, hence a sample confusion at this early stage is unlikely. Further, the consistency of some pairwise relatedness values suggested that sample mix-ups were not likely to have occurred during data analysis, where we might expect all individuals to be affected. Therefore, we concluded that mix-ups were most likely to have arisen in the most recent wet lab protocols.
Once the occurrence of sample mix-ups had been identified, we designed and implemented the framework described in the main text to more systematically identify sample mix-ups, and to validate those samples whose genotype appeared to be consistent with their relatives, in order to generate a dataset that we were confident could be used for further individual- and population-based analyses.

#### Marker and individual quality control
The initial SNP array dataset consists of 1,536 samples genotyped at 58,466 SNPs. 45,553 markers were designated as polymorphic high resolution according to the default quality control metrics in the Affymetrix Axiom Analysis Suite software. Because the purpose of our sample checks was to identify individuals with very high confidence and without ambiguity, we conservatively assumed that confirmed individuals must have been plated in a well on one of the genotyping plates designated for individuals from that population. For example, we did not look for Tiritiri Matangi samples in wells that were assigned to Te-Hauturu-o-Toi birds. The following steps were performed on hihi from the main population on Tiritiri Matangi island (N = 1,256), as they compromise the most complete dataset, a verified pedigree and the highest number of individuals across all populations.
A little less than half of the genotyped hihi from the island (N = 537) have both parents genotyped and included in the main data set. For 181 individuals, only the mother has been genotyped on the array, and for 355 individuals only the father has been genotyped. For the remaining 177 hihi that were genotyped with the custom SNP array, no parent genotypes are available; however, 62 of them produced offspring.

#### Blank, Control and Duplicate check
No blank or control samples were included in the array genotyping plates, and no duplicate individuals were intentionally included. However, in total, six duplicates (i.e. 12 samples) were identified by the default criteria in the Axiom Analysis Suite software. The individual replicate with the lowest genotyping rate was removed from the dataset prior to any other analysis (N = 1,250). Sample duplicate individuals can also be identified for example using the --genome function in the PLINK software (Purcell et al., 2007), in COLONY during analysis set-up or from the sequoia function in the package sequoia (Huisman 2017) in R 4.0.0 (R Development Core Team, 2012).

Principal Component Analysis 
We used the PLINK function –make-rel to calculate relatedness between all individuals from all five populations with the 40,616 SNP chip genotypes. We then calculated principal components using the function --pca. We used R to plot the first two principal components and the third and fourth principal components (Figure S1). The principal component analyses of the genomic data per population agreed with previous FST findings (Brekke et al., 2011), revealing that the five hihi populations have moderate levels of differentiation and population structure is overlapping between populations, particularly between populations that were sourced predominantly from Tiritiri Matangi (Figure S1).
Figure S1: Principal component analysis for the SNP data of all genotyped individuals (N=1456) using PLINK and R. The first panel plots PC1 against PC2 and the second panel shows PC3 versus PC4.
This result indicates that we can be reasonably certain that none (or only very few) of the samples have been swapped between the different hihi populations, as the sample-based population structure is grouping the populations separately as expected. However, it is possible that single samples of the Tiritiri Matangi genotypes might in fact have been plated in wells of individuals from a different population, but those wells are not taken into consideration in our analysis here (as we only inspect Tiritiri Matangi-assigned wells).

#### Sex check
The complete dataset of Tiritiri Matangi individuals selected to be genotyped on the SNP array compromised 645 male, 606 female and 5 individuals without a sex assigned from field observation.
Z-linked SNPs (identified as such via homology to the zebra finch genome and filtered in PLINK based on the .map file) were used to confirm the sex of the genotyped individuals by calculating homozygosity by locus (HL) for 2,694 sex markers in the 'GENHET' package in R (Coulon, 2010). Individuals with HL values of 0-0.2 were
assigned as male. Individuals with HL values of 0.8-1 were assigned as female, allowing for rare typing errors and SNPs in pseudo-autosomal regions, as in birds females are the heterozygous sex. For comparison, we also made use of the –check-sex function in PLINK, with the default 0.2/0.8 F-statistic threshold. A new sex and new ID was assigned to a sample where both tools agreed on the sex but it differed from the recorded morphological sex. For individuals with intermediate values from one or both genetic sex checks, the sex was conservatively set as unknown (0) and the sample ID flagged.
The sex check in both PLINK and GENHET confirmed 610 individuals as female, 548 hihi as male and 92 individuals that were not confidently assigned a sex, but whose heterozygosity levels appeared most consistent with being male. Hence, we find the initial sex ratio and the newly computed one to be similar. We identified 112 individuals where the field and genetic sex do not agree.

#### Check for relatedness consistency 
As a next step, we compared the pedigree-based and genomic relatedness of first-degree relationships of the individual hihi in order to identify more sample errors. As PLINK only reports Mendelian errors per family, sequoia only per SNP, and COLONY (Jones and Wang 2010) only indirectly, we instead built a custom-matrix in R. To do so, we first calculated the genomic relatedness between every pair of individuals using GCTA (Yang et al., 2011) and the pedigree-based relatedness using the R package kinship2 (Sinnwell et al., 2014). Then, for every genotyped individual, we identified whether their parents, full-siblings or offspring had been selected for genotyping, and extracted the genomic relatedness between this individual and every other first-degree relative (i.e. excluding half-siblings). These values were then input into a matrix, which enabled us to quickly scan for individuals involved in mix-ups and resolve some individuals where it was uncertain where in the family the sample mix-ups had happened. Based on the microsatellite-based pedigree of the 1,250 hihi, 4,710 known relationships among them present an expected relatedness of 0.5 or higher (e.g. parent-offspring). After comparing the expected relatedness between individuals with the observed relatedness calculated from the genotypic data (Figure 3), about two thirds of the family relationships were confirmed to be correct based on compatibility with at least one first-degree genotyped relative. If an individual has only one genotyped first-degree relative and matches that relative (genomic relatedness > 0.45), it was seen as a confirmed sample. Additionally, almost 4% of the observed relatedness values ranged from 0.15-0.35 (suggesting the examined hihi genotypes to belong to e.g. half-siblings, rather than full siblings), hence those samples were not validated and remained in the ‘grey zone’. Most importantly, nearly 20% of the genotypic relatedness values between first-degree relatives were ranging around zero (-0.0188 to 0.1), a clear indication of one or more samples in that family having been swapped or mixed-up. A sample was seen as relatively safe when it had less than a 0.1 kinship difference towards all first-degree relatives’ genotypes.
This way, the matrix helped identify around a thousand “erroneous” family relationships based on incorrect ID-genotype associations, with about a quarter of
them appearing in between a focal individual and either or both of its parents. In total, there were more than one hundred hihi individuals with near-zero relatedness towards all their (expected) relatives, and hence present clear sample mix-ups. These comparisons of genomic and pedigree-based relatedness give a good indication of how severe the mix-up situation is, but are not necessarily suitable for high confidence decisions on genotype-ID correctness.

#### Parentage assignment 
We used the R package sequoia and the stand-alone software COLONY to reconstruct pedigree relationships for all Tiritiri Matangi individuals. Sequoia makes use of a conservative hill-climbing algorithm to construct high likelihood pedigrees using relatively few markers, however, this heuristic, sequential approach also means that the inferred relationship between two individuals is not necessarily the true relationship (Huisman, 2017). COLONY on the other hand can employ one likelihood or two pairwise likelihood methods for inferring parentage and sibship (Jones & Wang, 2010; Wang, 2013), and has the advantage of being rather conservative and hence producing trustworthy pedigrees where the assignment confidences are reported separately.
The COLONY windows GUI helped create the input .dat file for COLONY for 1,079 of the hihi which have at least one genotyped parent. Data input comprised 939 SNPs in ‘1234 format’ after filtering in PLINK (--maf 0.4 --indep-pairwise 50 5 0.05 on all 45,553 SNPs; plus option --recode 12) and included 126 male and 110 female candidates that are offspring as well as potential parents to some of the 1079 offspring. The seed for the random number generator was set to 1234, a genotyping error rate of 0.01 and the number of known paternal or maternal sibships set to zero. The probability of the true parents being in the candidate lists was conservatively set at 0.5 for females and 0.5 for males to reflect the very high probability of recapture of the individuals on the island (Chauvenet et al., 2013). The inbreeding model was selected, polygamous mating system for both males and females allowed and the program ran using the FL-PLS-combined (FPLS) method at medium length.
For the analysis in sequoia, the COLONY files were transformed to .RAW (0/1/2) format in PLINK, however, sequoia has recently been updated to be able to read in many different data formats. An additional life history file with the sex and year of birth of the individuals was provided for the sequoia function performing sibship clustering and grandparent assignment. All 1,250 individuals were included in this analysis but the variants used previously in COLONY were further subsampled to 400 random SNPs in R as recommended by the author (Huisman, 2017). Further options for the full pedigree reconstruction in sequoia included the allowance for a genotyping error rate of 0.01, three mismatches per pair and a maximum number of eight iterations. All other options were set as default, as per the sequoia mid-2019 version.
For both sequoia and COLONY, dummy parents are assigned if other genotyped individuals cannot be assigned as parents. Parentage assignment in sequoia inferred a multigenerational pedigree where the 1,250 genotyped hihi have either a real hihi or
one (or two) of 133 dummy individuals assigned as parents. In COLONY, a more conservative tool, the new genotype-based pedigree included 119 dummy sires to 545 hihi and 159 dummy dams to 550 hihi. When comparing the verified pedigree to these two family reconstructions, for 354 samples the same two parents were assigned in all three cases. This indicates that these samples have correct ID-genotype associations all throughout the data processing and are safe to work with in future projects. In 107 cases, no pedigree agreed with each other. In another 42 cases, the two softwares agreed on a parental pair for a sample but are different from those noted in the verified pedigree. Those genotypes can be marked as ‘rejected’, but might also be resolved by backtracking which individual has those two parents assigned in the verified pedigree. This procedure is only possible for only-child offspring, saving 20 of the 42 individuals.
Further scrutinizing of the data might resolve the identity of some more mix-ups, but we want to acknowledge that hundreds of the samples may never be recovered unless we perform further genotyping from the original sample tubes, which we are confident are not mixed-up. What is more, we have only included individuals for the pedigree reconstruction that were genotyped from plate wells assigned to a Tiritiri Matangi bird; hence, more birds could be recovered if all array genotypes are considered simultaneously. Individuals whose field and genetic sex matched but without any first-degree relatives were conservatively considered unvalidated. Plotting of the relatedness values for confirmed and rejected first-degree Tiritiri Matangi relationships (Figure S3) support our claim that none of the rejected samples are indeed correct. On the other hand, the confirmed cases only show few outliers, which can be due to variation in inbreeding, and mostly show that the pedigree relatedness of those pairs is similar to the one observed when comparing their genotypes.

#### The use of whole-genome sequencing data
Another way of identifying sample errors is to calculate identity scores for genomic input of different resolutions for the same individuals, as confirmed by the answers of the 2020 survey. This means that, for instance, previously generated whole-genome sequencing data can help confirm that newly generated SNP datasets for the same individuals are correctly assigned the same ID. For ten hihi, we had whole-genome sequencing (WGS) data available that covered almost four million SNPs in their genome. In order to check that these WGS individuals were correctly allocated on the SNP array, we reduced the WGS files to those sites that are also genotyped with the hihi SNP array. Those files from two different genotyping processes were merged, resulting in a file containing each of the ten individuals twice. PLINK’s --genome function then confirmed that all ten hihi pairs had a pairwise IBD estimate of one, meaning that those ten hihi were assigned the correct ID during the SNP array genotyping. In this case, the three Tiritiri Matangi birds had been previously confirmed from the SNP array data only (correct sex, correct pedigree links) but we were able to verify that the seven WGS individuals from Te Hauturu-o-Toi were also correct.

#### Identifying sources of error 
For the Tiritiri Matangi population of hihi, a summary of the confirmed, corrected, unvalidated and rejected ID-genotype associations can be found in Table 2 in the main manuscript. In order to address whether wet lab errors arose from systematic mis-plating of samples, we mapped confirmed, unvalidated and rejected individuals across all genotyping plates. For this, we made use of the R package platetools (https://cran.r-project.org/package=platetools) that allowed us to colour code the wells according to the sample classification. When checking the confirmed versus rejected samples, we could not identify any systematic pattern of how the samples had been mixed-up. All plates seem to have been affected by sample mix-ups, with some plates having their samples more easily confirmed than others (Figure S4). There was no clear pattern with regard to only specific cohorts being affected by the mix-up, as affected samples spanned all years. All plates had at least one confirmed individual, which suggests that none of the plates were accidentally rotated by 180 degrees, which was an error mentioned by three participants in the online survey we conducted (see above).
Overall, while we were not able to trace back precisely the origin of the sample mix-ups of the hihi genotypes, we suspect that most errors occurred in the laboratory.
