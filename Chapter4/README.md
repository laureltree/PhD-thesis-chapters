
## Genomic data of different resolutions reveal consistent inbreeding estimates but contrasting homozygosity landscapes for the threatened Aotearoa New Zealand hihi

#### Genome assembly for the reference individual
We generated a draft genome assembly for Yellow using Oxford Nanopore Technologies (ONT) long read sequencing. Genomic DNA was extracted using the NEB Monarch gDNA extraction. Sequencing libraries were prepared using the ligation sequencing kit (LSK-109) and run across 8 MinION R9.4.1 flow cells. To maximise output, flow cells were flushed with the nuclease wash kit (WSH-003) and new library loaded 3–5 times during each sequencing run. A total of 62.7 Gb raw data was obtained following base-calling with Guppy v3.6.2 (https://github.com/nanoporetech). This data was filtered to remove any contaminating adaptor sequence using PoreChop v0.2.4 (Wick et al., 2017). Further filtering was performed with NanoPack tools (Wick et al., 2017): sequences derived from the DCS internal control were removed with Nanolyse v.1.2.0 (De Coster et al., 2018); reads were also filtered for quality (>q10) and to exclude reads shorter than 5 kb using NanoFilt v 2.6.0 (De Coster et al., 2018).

The filtered data set of 42.22 Gb with a read N50 of 14.8 kb was assembled using FLYE v2.7 (Kolmogorov et al., 2019) with the “keep haplotypes” flag enabled. The same reads were then used for two rounds of assembly polishing with racon (v 1.4.13; Vaser et al., 2017). The resulting draft assembly has a total size of 1058.9 Mb and is comprised of 1,117 contigs, with a contig N50 of 6.768 Mb. 98.2% of the assembly sequence is contained in 260 contigs of 300 kb or greater. Genome completeness is 92.2% as measured using BUSCO v 4.1.4 (Simao et al., 2015) with the odb10_aves data set.

The assembly was repeat masked using Repeat Masker v4.1.0 (Smit et al., 2015a) with a custom library created by combining all known avian repeats from Dfam release 3.2 (Hubley et al., 2016) with the output of de novo repeat identification in the draft hihi genome using RepeatModeler (open-1.0.11; Smit et al., 2015b). In total, 146.7 Mb, corresponding to 13.86% of the genome, was excluded by masking.

#### Genomic data and SNP genotyping
All 10 additional hihi under investigation have RAD-seq as well as whole genome resequencing data available, and have been genotyped using a custom 50 K Affymetrix SNP array. This array was developed before the generation of the hihi reference genome through identification of SNPs from de novo assembly of RAD-seq from 26 individuals, including these 10 birds, and low-coverage whole-genome sequencing (lcWGS) of these 10 individuals (detailed in de Villemereuil et al. (2019), Duntsch et al. (2020) and Lee et al. (2021)). Of the 58,466 SNPs included on the array, 45,553 markers passed initial default quality control metrics in the Axiom Analysis Suite software and were classified as “PolyHighResolution” (i.e., polymorphic SNPs with call rate of >95%, at least two minor alleles observed and genotype clusters well-separated) and were used in these analyses.

To locate SNPs from the lcWGS, RAD-seq and SNP array data sets in the reference assembly we mapped these data sets onto the assembly contigs. SNPs included in the SNP array were localised to positions in the Yellow reference assembly by BLAST searches using flanking sequences. The RAD-seq data from the 10 individuals was processed through the Stacks 2.53 pipeline (Catchen et al., 2013). Raw reads were submitted to process_radtags with default parameters. Individual, filtered read sets were mapped to the Yellow reference assembly using BWA-mem v0.7.17 (Li, 2013), manipulated in SAMtools v1.10 (Li et al., 2009) and then run through the Stacks populations analysis module as a single population to call SNPs. The lcWGS data set reads were first quality-filtered using Trimmomatic (v0.39; Bolger et al., 2014) with default settings and then aligned to the reference using BWA-mem. Genotyping was performed with GATK Haplotype Caller (v4.1.4.1) in GCVF mode (with -ERC BP_RESOLUTION; Poplin et al., 2018). Both the RAD-seq and lcWGS SNP data sets were filtered with BCFtools 1.10.2 to include only biallelic sites with a minimum minor allele count of three and SNPs in repeat regions excluded. In addition, the lcWGS data set was filtered in PLINK v1.9 (--max-missing 0.8 --maf 0.02; Chang et al., 2015) to ensure low levels of genotype call missingness. As recommended in Meyermans et al. (2020), no pruning for minor allele frequency or linkage disequilibrium was performed on any of the medium-density genotype data sets (RAD-seq, SNP array data). The RAD-seq data contains 26,447 SNPs with 18% average missing data, while the lcWGS filtering resulted in a final data set containing 2,018,863 genomic markers with a mean coverage of 7.45 and 2.2% missing data (Table S1).

To explore data sets of different marker density and quality, the lcWGS data for all 10 hihi was divided into marker sets at five different call depth stringency levels. In the first instance, the data remained as it was (2,018,863 sites; henceforth “lcWGS”), and in four other cases we adjusted the minimum mean depth (--min-meanDP) filtering threshold value in vcftools (Danecek et al., 2011). Only sites with mean depth values of greater than or equal to 6, 7, 8 and 9 over all 10 individuals are included in those new data sets, leaving 1,746,437 (“lcWGS6”), 1,302,507 (“lcWGS7”), 644,631 (“lcWGS8”) and 195,184 (“lcWGS9”) variants for further analysis.

#### SNP genotyping for the reference individual
Genotype calls for Yellow were obtained by mapping the long reads back to the reference assembly using Minimap2 v2.17 (Li, 2018) and calling sequence variants using longshot v0.4.1 (Edge & Bansal, 2019). The list of variant sites identified in a first round of genotyping were then augmented by sites identified as variable in the other sequence/genotyping data sets from the 10 individuals and recalled. Genotypes were called at the mapped lcWGS, SNP array and RAD-seq SNPs, as well as one data set combining all variants (including unique variants detected only in the reference genome assembly), for sites in the reference genome that had a longshot genotype quality (GQ) of greater than 150. These data sets comprise 1,562,384 (lcWGS), 46,136 (SNP array) and 18,415 (RAD-seq) sites, with 1,593,073 total variants when combining across data sets (combined; information on intermarker distance for each data set in Figure S1 and on frequency distribution in Figure S2). Note that the total number of SNP array and RAD-seq sites genotyped in Yellow is slightly lower than for the set of 10 individuals, as some SNP sites did not meet the base quality threshold in the reference male.

Finally, a “whole genome” data set was constructed with 904,228,112 sites, providing sufficient resolution to estimate the “true” inbreeding value for this reference individual. To do so, we extracted genotype calls from the assembly where possible (where homozygous calls GQ>100 and heterozygous calls GQ>150) and assumed all other sites reaching a base quality of >100 and depth threshold of 10 were homozygous. Sites were excluded if they were annotated as repeats or fell in regions with >2 SNPs in a 100 bp window (assessed from the combined SNP data set). To acquire additional data sets of different SNP densities, the combined data set of 1,593,073 SNPs was then randomly downsampled to subsets of SNPs representing 1/2 (i.e., 796,537 SNPs), 1/4, 1/8, 1/16, 1/32, 1/64, 1/128 and 1/256 (i.e., 6,223 SNPs) of the total, with 10 replicates for each. In addition, 10 replicate data sets sampling the number of SNP array and RAD-seq SNPs at random from the combined data set were also generated.

#### Runs of homozygosity
ROH were first examined with the sliding windows approach in PLINK using the --homozyg function. Given the differences in the density of SNPs across the genome for each data set, we followed the suggestion by Kardos et al., (2015) to tailor the settings for the ROH analysis with the aim to detect runs in a consistent manner across the SNP data sets. In particular, we adjusted the minimum average density of SNPs, the maximum gap length between adjacent SNPs, the size of the sliding window and the minimum number of variants needed to be able to detect a ROH to reflect the average SNP density of each data set (Table S2). We allowed for one (for the SNP array and RAD-seq data sets) or two (for the higher density data sets) heterozygous and one missing site per window, to account for possible genotyping errors. In order to report comparable total lengths of homozygous segments across data sets, we set the required minimum length for ROH to 300 kb, ensuring that short ROH deriving from linkage disequilibrium are excluded (Meyermans et al., 2020). These adjusted PLINK settings were applied to infer runs of homozygosity for both the reference genome individual (Yellow) and for the additional 10 birds (Hihi_01–Hihi_10). Detailed explanations about how the chosen settings were optimised can be found in the Supporting Information Methods. We calculated the genome coverage parameter (the maximal ROH length the analysis can discover) of our SNP data sets by converting all SNPs in the different data sets to homozygous, determining the total inferred size of homozygous regions >300 kb, and dividing this number by the total assembled genome size of 1,046.4 Mb (Meyermans et al., 2020).

For Yellow, we assessed the concordance between the full genome and each of the other data sets by subsampling the full genome to the SNPs shared with the focal data set and calculating (i) the proportion of SNPs called within a ROH in the full genome that were also called within a ROH in the focal data set and (ii) the proportion of SNPs called outside a ROH in the full genome that were also called outside a ROH in the focal data set.

#### Inbreeding coefficients and multilocus heterozygosity
Individual inbreeding coefficients based on detected runs of homozygosity (FROH) were estimated by summing the length of all ROH greater than 300 kb and 500 kb and dividing the sum by the assembly size of contigs >300 kb (1.04 Gb) and >500 kb (1.035 Gb).

Furthermore, for the 10 individuals for the lcWGS, SNP array and RAD-seq data sets, genomic inbreeding coefficients FG were calculated using PLINK. PLINK implements the --ibc function from the software GCTA (Yang et al., 2011) to report three measures of FG, we here report method III, which is based on the correlation between uniting gametes (FIBC). PLINK’s --het function was also used to calculate FG based on observed autosomal homozygous genotype counts for each individual (FHET).

MLH was inferred with the lcWGS8 data set using the InbreedR (Stoffel et al., 2016) package in R (R Core Team, 2013). Correlation coefficients between MLH and all genomic inbreeding estimates for the 10 hihi were calculated using Pearson statistics in R.

In addition, we scanned the data sets for the 10 hihi (Hihi_01–Hihi_10) for homozygous-by-descent (HBD) segments (Druet & Gautier, 2017) using the R package RZooRoH (Bertrand et al., 2019). RZooRoH implements a hidden Markov model to identify HBD segments and allows for the estimation of an inbreeding coefficient FRZooRoH. The genotyping error rate was set to 0.25% (Ferenčaković et al., 2013). The analysis was performed using a mixKR model, with K = 4, 8 and 13 as the number of age-related HBD classes. Following advice from an RZooRoH author, inbreeding over all classes for K = 4 (Tom Druet, personal communication) was summed and correlated with PLINK ROH-based inbreeding estimates across all 10 hihi individuals (as seen in Meyermans et al., 2020).

All summary statistics, correlations, and plots were generated in R using the R packages ggplot2, dplyr, ggpubr, data.table and the bird colour-based package Manu.
